generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model League {
  id                Int                @id @default(autoincrement())
  guildId           String             // Discord server ID
  createdBy         String             // Discord user ID of the league creator
  name              String
  description       String?
  format            String             // User-defined format (e.g., "Standard", "Modern", "Limited")
  competitionType   String             // SWISS, SWISS_WITH_TOP_CUT, DOUBLE_ELIMINATION, SINGLE_ELIMINATION
  hasTopCut         Boolean            @default(false)
  topCutSize        Int?               // Number of players in top cut (e.g., 8, 16)
  status            String             @default("REGISTRATION") // REGISTRATION, IN_PROGRESS, TOP_CUT, COMPLETED, CANCELLED
  currentRound      Int                @default(0)
  totalRounds       Int?
  roundTimerMinutes Int?               // Optional round timer in minutes
  announcementChannelId String?        // Channel where timer announcements are sent
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  registrations     Registration[]
  rounds            Round[]
  matches           Match[]
  auditLogs         AuditLog[]
  
  @@unique([guildId, name])
  @@index([guildId])
}

model Player {
  id                Int                @id @default(autoincrement())
  discordId         String             @unique
  username          String
  createdAt         DateTime           @default(now())
  
  registrations     Registration[]
  matchesAsPlayer1  Match[]            @relation("Player1Matches")
  matchesAsPlayer2  Match[]            @relation("Player2Matches")
}

model Registration {
  id                Int                @id @default(autoincrement())
  leagueId          Int
  playerId          Int
  tournamentId      String?            // ID in tournament-organizer
  wins              Int                @default(0)
  losses            Int                @default(0)
  draws             Int                @default(0)
  matchPoints       Int                @default(0)
  gamePoints        Int                @default(0)
  omwPercent        Float              @default(0)
  gwPercent         Float              @default(0)
  ogwPercent        Float              @default(0)
  isActive          Boolean            @default(true)
  isDropped         Boolean            @default(false)
  registeredAt      DateTime           @default(now())
  
  league            League             @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  player            Player             @relation(fields: [playerId], references: [id])
  
  @@unique([leagueId, playerId])
  @@index([leagueId])
}

model Round {
  id                Int                @id @default(autoincrement())
  leagueId          Int
  roundNumber       Int
  isTopCut          Boolean            @default(false)
  startedAt         DateTime           @default(now())
  completedAt       DateTime?
  timerStartsAt     DateTime?          // When the round timer actually starts (after 5 min grace period)
  timerEndsAt       DateTime?          // When the round timer ends
  
  league            League             @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  matches           Match[]
  
  @@unique([leagueId, roundNumber])
}

model Match {
  id                Int                @id @default(autoincrement())
  leagueId          Int
  roundId           Int?
  player1Id         Int
  player2Id         Int?
  player1Wins       Int                @default(0)
  player2Wins       Int                @default(0)
  draws             Int                @default(0)
  winnerId          Int?
  isDraw            Boolean            @default(false)
  isBye             Boolean            @default(false)
  isCompleted       Boolean            @default(false)
  tableNumber       Int?
  reportedAt        DateTime?
  createdAt         DateTime           @default(now())
  
  league            League             @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  round             Round?             @relation(fields: [roundId], references: [id])
  player1           Player             @relation("Player1Matches", fields: [player1Id], references: [id])
  player2           Player?            @relation("Player2Matches", fields: [player2Id], references: [id])
  
  @@index([leagueId])
  @@index([roundId])
}

model AuditLog {
  id                Int                @id @default(autoincrement())
  leagueId          Int
  userId            String             // Discord user ID who made the change
  username          String             // Discord username at time of change
  action            String             // Type of action: MODIFY_MATCH, REPAIR_ROUND, START_TOURNAMENT, etc.
  entityType        String             // MATCH, ROUND, LEAGUE
  entityId          Int?               // ID of the entity affected
  oldValue          String?            // JSON string of old state
  newValue          String?            // JSON string of new state
  description       String             // Human-readable description
  createdAt         DateTime           @default(now())
  
  league            League             @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  
  @@index([leagueId])
  @@index([userId])
  @@index([createdAt])
}
